<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="dc.identifier" content="{{ thing_identifier|safe }}">
  <meta name="dc.relation.ispartof" content="{{ thing_ispartof|safe }}">
  <title>iSamples JSON Page</title>
  <link href='https://fonts.googleapis.com/css?family=Open Sans' rel='stylesheet'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin="" />
  </link>
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>
  <script type="application/ld+json">{{ thing_json|safe }}</script>
  <link rel="stylesheet" type="text/css"
    href="https://cdn.jsdelivr.net/gh/isamplesorg/isamples_webui@develop/record-page/src/css/index.css">
  </link>
  <script src="https://hypothes.is/embed.js" async></script>
  <script>
const ZOOM_LEVEL = 6;
const NO_ZOOM_LEVEL = 0;
const DEFAULT_LOCATION = [0, 0];

/**
 * A function to convert field name to the well format
 *
 * @param {*} key, a string of field name
 * @return {*} a string
*/
function wellFormatKey(key) {
    const newKey = key.replace('resolved_content', "").replace(" ", "");
    return newKey.split(' ').map(word => word.slice(0, 1).toUpperCase() + word.slice(1)).join(' ');
}

/**
 * A function to check if the string is a valid url
 *
 * @param {*} value, a string of the possible url
*/
function isURL(value) {
    let url;
    try {
        url = new URL(value);
    } catch (e) {
        return false
    }

    return url.protocol === 'http:' || url.protocol === 'https:';
}

/**
 * A function to reconstruct the json Data
 *
 * @params {*} prevKey, a string of parent name
 * @params {*} jsonData, a json object
 * @return {*} a new json object
 */
function cleanJSON(prevKey, jsonData) {
    let result = {};
    for (let key of Object.keys(jsonData)) {
        // remove the empty fields
        if (!jsonData[key] || jsonData[key].length === 0 || jsonData[key] === "Not Provided") {
            continue;
        }
        const newKey = prevKey + " " + key;

        // if the child is a hashtable or array
        // deal with the child object
        if (typeof jsonData[key] === 'object') {
            // if the child is an arrary
            if (Array.isArray(jsonData[key])) {
                // concatenate pure string array
                if (typeof jsonData[key][0] === 'string') {
                    result[newKey] = jsonData[key].join(', ');
                } else {
                    // if the value is object array, do string manipulation
                    const list = jsonData[key].map(v => JSON.stringify(v).replaceAll(/"|{|}/g, "")).join('\r\n')
                    result[newKey] = list;
                }
            } else {
                // do recursion to children
                result = Object.assign({}, result, cleanJSON(newKey, jsonData[key]));
            }
        } else {
            result[newKey] = jsonData[key];
        }
    }
    return result;
}

/**
 * A function to create html table based on json data
 *
 * @params {*} data, a json object
 * @return {*} a table html object
*/
function createTable(data) {
    const table = document.createElement('table');
    table.className = "table table-sm table-striped table-responsive table-hover ";

    // Create table title
    const thead = document.createElement('thead');
    thead.innerHTML =
        `<tr>
            <th>Variable</th>
            <th>Value(s)</th>
        </tr>`;

    // Create table body
    const tbody = document.createElement('tbody');

    const htmlBody = Object.keys(data).map((key) =>
        `<tr>
            <td>
                ${wellFormatKey(key)}
            </td>
            <td id='tbValue'>
                ${isURL(data[key]) ? `<a href=${data[key]}>${data[key]}</a>` : `<span>${data[key]}</span>`}
            </td>
        </tr>`)
    tbody.innerHTML = htmlBody.join('');
    table.appendChild(thead);
    table.appendChild(tbody);
    return table;
}

/**
 * a function to find latitude and longitude position
 *
 * @params {*} data, a json object
 * @params {*} field, "latitude" or "longitude"
 * @return {*} a float of value of geoinformation
 */
function findGeoInfo(data, field) {
    const fieldStart = JSON.stringify(data).indexOf(field);
    if (typeof(fieldStart) === "undefined") {
      return NaN;
    }
    const fieldLength = JSON.stringify(data).substring(fieldStart).indexOf(',');
    const fieldValue = JSON.stringify(data).substring(fieldStart, fieldStart + fieldLength);
    return parseFloat(fieldValue.split(':')[1].replaceAll('"', ""));
}

/**
 * A function to add map into page
 *
 * @params {*} location, an arrary, [latitude, longitude]
*/
function createMap(location) {
    const noGeo = location.includes(NaN);
    var map = L.map('map').setView(noGeo ? DEFAULT_LOCATION : location, noGeo ? NO_ZOOM_LEVEL : ZOOM_LEVEL);
    L.tileLayer('https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    L.marker(location.includes(NaN) ? DEFAULT_LOCATION : location).addTo(map);

    // add a popup window to indicate there is no geo information
    if (location.includes(NaN)) {
        L.popup({
            closeButton: false,
            autoClose: false
        })
            .setLatLng(DEFAULT_LOCATION)
            .setContent('<p>No Geo Information</p>')
            .openOn(map);
    }
}

/**
 * A function to create material record citation
 *
 * @params {*} data, a json object
*/
function createCitation(data) {
    // find contributors
    let contributors = "";
    if (Object.keys(data).includes(" registrant") && data[" registrant"] && data[" registrant"].length > 0) {
        contributors = data[" registrant"];
    } else {
        contributors = data[" producedBy responsibility"] || "";
    }

    // the required fields
    const resultTime = data[" producedBy resultTime"];
    const id = data[" sampleidentifier"];
    const label = data[" label"];
    const placeName = data[" producedBy samplingSite placeName"] || "";

    const citation = `${contributors.length > 0 ? contributors : ""} ` +
        `"${label}". ` +
        `${placeName.length > 0 ? `<em>${placeName}</em>.`: ""} ` +
        `Released:${resultTime}. ${id}`;
    return citation;
}

/**
 * A function to add all elements into page body
*/
function extractJsonldFromDOM() {
    const eles = document.querySelector('script[type="application/ld+json"]');
    if (eles.innerHTML.trim() === "") {
        return
    }

    const _jsonld = JSON.parse(eles.innerHTML);
    // apply functions to manipulate the json data
    const newFieldsDict = cleanJSON("", _jsonld);
    document.getElementById('TableView').appendChild(createTable(newFieldsDict));
    document.getElementById('citation').innerHTML = createCitation(newFieldsDict);
    createMap([findGeoInfo(_jsonld, 'latitude'), findGeoInfo(_jsonld, 'longitude')]);
};

//window.addEventListener('load', extractJsonldFromDOM());

async function fetchGrantToken() {
  var grantToken = "";
  // The story as of right now is that we only appear to have the "previousParams" session cookie showing up in
  // this data structure.  If I go into Chrome, I can definitely see the session cookie, so something about how
  // this is reading the cookies isn't getting that for some reason.
  // const cookies = new Cookies();
  // cookies.set('logged', true, { path: "/" });
  // console.log("cookies are ", cookies);
  // console.log("document cookies are ", document.cookie)

  // console.log("session cookie is ", sessionCookieValue);
  fetch("http://localhost:8000/manage/hypothesis_jwt", {
    'method': 'POST',
    credentials: "include",
    headers: {
      'Content-Type': 'application/json'
    }
  })
    .then((res) => {
      // check the POST return status
      const { status } = res;
      console.log("token response status is ", status);
      if (status === 200) {
        return res.text();
      } else {
        throw new Error(res);
      }
    })
    .then((grantToken) => {
      console.log("grant token is ", grantToken)
      window.grantToken = grantToken.replace(/"/g, '');
    },
      (error) => {
        console.warn(error);
        window.grantToken = "";
      }
    )
  console.log("grant token is ", grantToken);
  window.hypothesisConfig = function () {
    var hypothesisConfig = {
        "services": [{
          "apiUrl": "http://localhost:5000/api/",
          "authority": "isample.xyz",
          "onLoginRequest": function () {
            window.location.assign("http://localhost:8000/manage/login?thing={{ thing_identifier|safe }}");
          },
          "onLogoutRequest": function () {
            window.location.assign("http://localhost:8000/manage/logout");
          }
        }]
    };
    console.log("here is the hypothesis config");
    if (window.grantToken.length > 0) {
      hypothesisConfig["grantToken"] = window.grantToken;
      console.log("just set hypothesisConfig grantToken to", window.grantToken);
    }
    return hypothesisConfig;
  };
}
console.log("About to add event listener");
window.addEventListener('load', fetchGrantToken());
  </script>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <img src="https://isamplesorg.github.io/assets/isampleslogopetal.png" alt="iSamples Logo Petal" width="100"></img>
    <span class="navbar-brand ms-2">Internet of Samples: iSamples</span>
  </nav>
  <div class="container-fluid p-3">
    <div class="row">
      <div class="col-sm-8">
        <div class="card">
          <div class="card-header"><b>Description</b></div>
          <div id='TableView' class="card-body"></div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="vstack gap-3">
          <div class="card">
            <div class="card-header">Citation</div>
            <div id="citation" class="card-body"></div>
          </div>
          <div>
            <h5>Map Data</h5>
            <div id="map"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <footer>
    <div class="d-flex flex-wrap justify-content-between align-items-center p-4 border-top fixed-bottom">
      <div class="text-center text-muted">© Copyright 2020, iSamples Project.This material is based upon work
        supported
        by the National Science Foundation under Grant Numbers 
          <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004839">2004839</a>, 
          <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004562">2004562</a>, 
          <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004642">2004642</a>, and 
          <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004815">2004815</a>. Any opinions, findings, and
        conclusions or recommendations expressed in this material are those of the author(s) and do not
        necessarily reflect the views of the <a href="https://nsf.gov/">National Science Foundation</a>.
      </div>
    </div>
  </footer>
</body>

</html>